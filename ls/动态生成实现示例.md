# 动态生成 2048 游戏实现示例

## 🎯 核心实现思路

### 1. 动态路由系统

```typescript
// app/[themeId]/page.tsx - 动态路由页面
import { notFound } from "next/navigation";
import { DynamicGameBoard } from "@/components/game/DynamicGameBoard";
import { ThemeManager } from "@/lib/game/themeManager";
import { SEOHead } from "@/components/seo/SEOHead";

interface PageProps {
  params: {
    themeId: string;
  };
}

export default async function ThemePage({ params }: PageProps) {
  const themeManager = new ThemeManager();
  const theme = await themeManager.loadTheme(params.themeId);

  if (!theme) {
    notFound();
  }

  return (
    <>
      <SEOHead
        title={`${theme.name} 2048 - Play Online Free`}
        description={`Play ${theme.name} 2048 online for free! Custom themed puzzle game.`}
        keywords={`${theme.name} 2048, ${theme.name} puzzle game, custom 2048`}
        canonical={`https://playing2048.com/${theme.id}`}
      />

      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
        <div className="container mx-auto px-4 py-8">
          <header className="text-center mb-8">
            <h1 className="text-4xl font-bold mb-2">{theme.name} 2048</h1>
            <p className="text-gray-600">{theme.description}</p>
          </header>

          <DynamicGameBoard theme={theme} />
        </div>
      </div>
    </>
  );
}

// 生成静态路径（可选）
export async function generateStaticParams() {
  const themeManager = new ThemeManager();
  const themes = await themeManager.getAllThemes();

  return themes.map((theme) => ({
    themeId: theme.id,
  }));
}
```

### 2. 图片生成服务

```typescript
// lib/services/imageGenerationService.ts
export class ImageGenerationService {
  private stabilityApiKey: string;
  private openaiApiKey: string;

  constructor() {
    this.stabilityApiKey = process.env.STABILITY_API_KEY!;
    this.openaiApiKey = process.env.OPENAI_API_KEY!;
  }

  async generateThemeImages(
    theme: string,
    count: number = 12
  ): Promise<string[]> {
    // 优先使用Stability AI，备用OpenAI
    try {
      return await this.generateWithStability(theme, count);
    } catch (error) {
      console.log("Stability AI failed, trying OpenAI...");
      return await this.generateWithOpenAI(theme, count);
    }
  }

  private async generateWithStability(
    theme: string,
    count: number
  ): Promise<string[]> {
    const images: string[] = [];

    for (let i = 0; i < count; i++) {
      const prompt = this.generateStabilityPrompt(theme, i);

      const response = await fetch(
        "https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/text-to-image",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${this.stabilityApiKey}`,
          },
          body: JSON.stringify({
            text_prompts: [{ text: prompt, weight: 1 }],
            cfg_scale: 7,
            height: 512,
            width: 512,
            samples: 1,
            steps: 30,
          }),
        }
      );

      if (!response.ok) {
        throw new Error(`Stability API error: ${response.statusText}`);
      }

      const result = await response.json();
      if (result.artifacts && result.artifacts[0]) {
        const imageData = result.artifacts[0].base64;
        images.push(`data:image/png;base64,${imageData}`);
      }
    }

    return images;
  }

  private async generateWithOpenAI(
    theme: string,
    count: number
  ): Promise<string[]> {
    const images: string[] = [];

    for (let i = 0; i < count; i++) {
      const prompt = this.generateOpenAIPrompt(theme, i);

      const response = await fetch(
        "https://api.openai.com/v1/images/generations",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${this.openaiApiKey}`,
          },
          body: JSON.stringify({
            prompt: prompt,
            n: 1,
            size: "512x512",
            response_format: "b64_json",
          }),
        }
      );

      if (!response.ok) {
        throw new Error(`OpenAI API error: ${response.statusText}`);
      }

      const result = await response.json();
      if (result.data && result.data[0]) {
        const imageData = result.data[0].b64_json;
        images.push(`data:image/png;base64,${imageData}`);
      }
    }

    return images;
  }

  private generateStabilityPrompt(theme: string, index: number): string {
    const styles = [
      "simple icon design, flat style, white background",
      "cute cartoon style, simple design, white background",
      "minimalist flat design, clean lines, white background",
      "pixel art style, simple, white background",
      "geometric design, simple shapes, white background",
      "modern icon, flat design, white background",
      "retro style, simple design, white background",
      "vector art, clean design, white background",
      "abstract representation, simple design, white background",
      "stylized icon, flat design, white background",
      "modern minimalist, simple design, white background",
      "clean icon design, white background",
    ];

    return `${theme}, ${styles[index]}, suitable for 2048 game tile, high contrast`;
  }

  private generateOpenAIPrompt(theme: string, index: number): string {
    const styles = [
      "simple icon design",
      "cute cartoon style",
      "minimalist flat design",
      "pixel art style",
      "geometric design",
      "modern icon",
      "retro style",
      "vector art",
      "abstract representation",
      "stylized icon",
      "modern minimalist",
      "clean icon design",
    ];

    return `${theme}, ${styles[index]}, white background, simple design, suitable for 2048 game tile, high contrast, no text`;
  }
}
```

### 3. 游戏生成 API

```typescript
// app/api/generate-game/route.ts
import { NextRequest, NextResponse } from "next/server";
import { DynamicGameGenerator } from "@/lib/game/dynamicGameGenerator";
import { ImageGenerationService } from "@/lib/services/imageGenerationService";

export async function POST(request: NextRequest) {
  try {
    const { themeName, customImages } = await request.json();

    const generator = new DynamicGameGenerator();
    const imageService = new ImageGenerationService();

    let theme;

    if (customImages && customImages.length > 0) {
      // 使用用户上传的图片
      theme = await generator.generateGameFromImages(themeName, customImages);
    } else {
      // 使用AI生成图片
      const images = await imageService.generateThemeImages(themeName);
      theme = await generator.generateGameFromImages(themeName, images);
    }

    return NextResponse.json({
      success: true,
      theme: {
        id: theme.id,
        name: theme.name,
        url: `/${theme.id}`,
      },
    });
  } catch (error) {
    console.error("Game generation failed:", error);
    return NextResponse.json(
      { success: false, error: "Failed to generate game" },
      { status: 500 }
    );
  }
}
```

### 4. 用户界面组件

```typescript
// components/theme/CreateGameForm.tsx
"use client";

import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card } from "@/components/ui/card";
import { ImageUploader } from "./ImageUploader";

export const CreateGameForm = () => {
  const [themeName, setThemeName] = useState("");
  const [customImages, setCustomImages] = useState<File[]>([]);
  const [isGenerating, setIsGenerating] = useState(false);
  const [generatedTheme, setGeneratedTheme] = useState<any>(null);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!themeName.trim()) {
      alert("Please enter a theme name");
      return;
    }

    setIsGenerating(true);

    try {
      const response = await fetch("/api/generate-game", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          themeName: themeName.trim(),
          customImages:
            customImages.length > 0 ? await processImages(customImages) : null,
        }),
      });

      const result = await response.json();

      if (result.success) {
        setGeneratedTheme(result.theme);
        // 跳转到生成的游戏页面
        window.location.href = result.theme.url;
      } else {
        alert("Failed to generate game: " + result.error);
      }
    } catch (error) {
      console.error("Generation failed:", error);
      alert("Failed to generate game. Please try again.");
    } finally {
      setIsGenerating(false);
    }
  };

  const processImages = async (files: File[]): Promise<string[]> => {
    const processedImages: string[] = [];

    for (const file of files) {
      const base64 = await fileToBase64(file);
      processedImages.push(base64);
    }

    return processedImages;
  };

  const fileToBase64 = (file: File): Promise<string> => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result as string);
      reader.onerror = (error) => reject(error);
    });
  };

  return (
    <Card className="p-6 max-w-2xl mx-auto">
      <h2 className="text-2xl font-bold mb-6">Create Your Custom 2048 Game</h2>

      <form onSubmit={handleSubmit} className="space-y-6">
        <div>
          <label htmlFor="themeName" className="block text-sm font-medium mb-2">
            Theme Name
          </label>
          <Input
            id="themeName"
            type="text"
            value={themeName}
            onChange={(e) => setThemeName(e.target.value)}
            placeholder="e.g., Sun Wukong, Cars, Animals..."
            required
          />
        </div>

        <div>
          <label className="block text-sm font-medium mb-2">
            Upload Custom Images (Optional)
          </label>
          <ImageUploader onImagesSelected={setCustomImages} />
          <p className="text-sm text-gray-500 mt-2">
            If you don't upload images, we'll generate them using AI
          </p>
        </div>

        <Button
          type="submit"
          disabled={isGenerating || !themeName.trim()}
          className="w-full"
        >
          {isGenerating ? "Generating..." : "Generate My 2048 Game"}
        </Button>
      </form>

      {generatedTheme && (
        <div className="mt-6 p-4 bg-green-50 rounded-lg">
          <p className="text-green-800">
            Game generated successfully! Redirecting to{" "}
            <a href={generatedTheme.url} className="font-bold underline">
              {generatedTheme.name} 2048
            </a>
          </p>
        </div>
      )}
    </Card>
  );
};
```

### 5. 图片上传组件

```typescript
// components/theme/ImageUploader.tsx
"use client";

import { useState, useRef } from "react";
import { Button } from "@/components/ui/button";
import { Upload, X } from "lucide-react";

interface ImageUploaderProps {
  onImagesSelected: (files: File[]) => void;
  maxImages?: number;
}

export const ImageUploader: React.FC<ImageUploaderProps> = ({
  onImagesSelected,
  maxImages = 12,
}) => {
  const [selectedFiles, setSelectedFiles] = useState<File[]>([]);
  const [previews, setPreviews] = useState<string[]>([]);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(event.target.files || []);

    if (selectedFiles.length + files.length > maxImages) {
      alert(`You can only upload up to ${maxImages} images`);
      return;
    }

    const newFiles = [...selectedFiles, ...files];
    setSelectedFiles(newFiles);
    onImagesSelected(newFiles);

    // 生成预览
    files.forEach((file) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        setPreviews((prev) => [...prev, e.target?.result as string]);
      };
      reader.readAsDataURL(file);
    });
  };

  const removeImage = (index: number) => {
    const newFiles = selectedFiles.filter((_, i) => i !== index);
    const newPreviews = previews.filter((_, i) => i !== index);

    setSelectedFiles(newFiles);
    setPreviews(newPreviews);
    onImagesSelected(newFiles);
  };

  return (
    <div className="space-y-4">
      <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
        <Upload className="mx-auto h-12 w-12 text-gray-400" />
        <div className="mt-4">
          <Button
            type="button"
            variant="outline"
            onClick={() => fileInputRef.current?.click()}
          >
            Select Images
          </Button>
          <p className="text-sm text-gray-500 mt-2">
            PNG, JPG up to 10MB each (max {maxImages} images)
          </p>
        </div>
        <input
          ref={fileInputRef}
          type="file"
          multiple
          accept="image/*"
          onChange={handleFileSelect}
          className="hidden"
        />
      </div>

      {previews.length > 0 && (
        <div>
          <h4 className="text-sm font-medium mb-2">
            Selected Images ({selectedFiles.length}/{maxImages})
          </h4>
          <div className="grid grid-cols-3 md:grid-cols-4 gap-2">
            {previews.map((preview, index) => (
              <div key={index} className="relative">
                <img
                  src={preview}
                  alt={`Preview ${index + 1}`}
                  className="w-full h-20 object-cover rounded-lg"
                />
                <button
                  type="button"
                  onClick={() => removeImage(index)}
                  className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600"
                >
                  <X className="h-3 w-3" />
                </button>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};
```

## 🔧 环境配置

### 1. 环境变量设置

```bash
# .env.local
STABILITY_API_KEY=your_stability_api_key_here
OPENAI_API_KEY=your_openai_api_key_here
NEXT_PUBLIC_SITE_URL=https://playing2048.com
```

### 2. API 密钥获取

1. **Stability AI**: 注册 https://platform.stability.ai/
2. **OpenAI**: 注册 https://platform.openai.com/

### 3. 部署配置

```json
// vercel.json
{
  "functions": {
    "app/api/generate-game/route.ts": {
      "maxDuration": 60
    }
  }
}
```

## 🚀 使用流程

1. **用户访问创建页面** `/create`
2. **输入主题名称** 或上传自定义图片
3. **系统生成图片** 使用 AI 或用户上传的图片
4. **创建游戏主题** 并保存到数据库
5. **生成动态页面** 创建 `/[themeId]` 路由
6. **用户开始游戏** 在生成的页面上玩 2048

这个实现方案可以让你创建真正的动态 2048 游戏生成系统，用户可以选择任何主题，系统会自动生成对应的游戏！
