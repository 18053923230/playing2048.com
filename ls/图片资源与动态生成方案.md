# 图片资源与动态生成 2048 游戏方案

## 🎯 核心需求分析

用户需求：

- 选择任意图片主题（孙悟空、汽车、动物等）
- 自动生成对应的 2048 游戏（sunwukong 2048、car 2048 等）
- 实现真正的自定义化

## 🖼️ 图片资源获取策略

### 方案 1：AI 生成图片（推荐）

#### 使用 Stable Diffusion API

```typescript
// lib/imageGeneration/stableDiffusion.ts
interface ImageGenerationRequest {
  prompt: string;
  style: string;
  count: number;
  size: "256x256" | "512x512" | "1024x1024";
}

export class ImageGenerator {
  private apiKey: string;
  private baseUrl = "https://api.stability.ai/v1/generation";

  constructor(apiKey: string) {
    this.apiKey = apiKey;
  }

  async generateThemeImages(
    theme: string,
    count: number = 12
  ): Promise<string[]> {
    const prompts = this.generatePrompts(theme, count);
    const images: string[] = [];

    for (const prompt of prompts) {
      try {
        const response = await fetch(
          `${this.baseUrl}/stable-diffusion-xl-1024-v1-0/text-to-image`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${this.apiKey}`,
            },
            body: JSON.stringify({
              text_prompts: [
                {
                  text: prompt,
                  weight: 1,
                },
              ],
              cfg_scale: 7,
              height: 512,
              width: 512,
              samples: 1,
              steps: 30,
            }),
          }
        );

        const result = await response.json();
        if (result.artifacts && result.artifacts[0]) {
          const imageData = result.artifacts[0].base64;
          images.push(`data:image/png;base64,${imageData}`);
        }
      } catch (error) {
        console.error("Image generation failed:", error);
      }
    }

    return images;
  }

  private generatePrompts(theme: string, count: number): string[] {
    const basePrompts = [
      `${theme}, simple icon, flat design, white background, 2D style`,
      `${theme}, cute cartoon, simple design, white background`,
      `${theme}, minimalist icon, clean design, white background`,
      `${theme}, pixel art style, simple, white background`,
      `${theme}, geometric design, simple shapes, white background`,
      `${theme}, modern icon, flat design, white background`,
      `${theme}, retro style, simple design, white background`,
      `${theme}, vector art, clean design, white background`,
      `${theme}, abstract representation, simple design, white background`,
      `${theme}, stylized icon, flat design, white background`,
      `${theme}, modern minimalist, simple design, white background`,
      `${theme}, clean icon design, white background`,
    ];

    return basePrompts.slice(0, count);
  }
}
```

#### 使用 OpenAI DALL-E API

```typescript
// lib/imageGeneration/dalle.ts
export class DalleGenerator {
  private apiKey: string;

  constructor(apiKey: string) {
    this.apiKey = apiKey;
  }

  async generateThemeImages(
    theme: string,
    count: number = 12
  ): Promise<string[]> {
    const images: string[] = [];

    for (let i = 0; i < count; i++) {
      const prompt = this.generatePrompt(theme, i);

      try {
        const response = await fetch(
          "https://api.openai.com/v1/images/generations",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${this.apiKey}`,
            },
            body: JSON.stringify({
              prompt: prompt,
              n: 1,
              size: "512x512",
              response_format: "b64_json",
            }),
          }
        );

        const result = await response.json();
        if (result.data && result.data[0]) {
          const imageData = result.data[0].b64_json;
          images.push(`data:image/png;base64,${imageData}`);
        }
      } catch (error) {
        console.error("DALL-E generation failed:", error);
      }
    }

    return images;
  }

  private generatePrompt(theme: string, index: number): string {
    const styles = [
      "simple icon design",
      "cute cartoon style",
      "minimalist flat design",
      "pixel art style",
      "geometric design",
      "modern icon",
      "retro style",
      "vector art",
      "abstract representation",
      "stylized icon",
      "modern minimalist",
      "clean icon design",
    ];

    return `${theme}, ${styles[index]}, white background, simple design, suitable for 2048 game tile`;
  }
}
```

### 方案 2：预设图片库 + 用户上传

#### 预设主题图片库

```typescript
// lib/imageLibrary/presetThemes.ts
export interface PresetTheme {
  id: string;
  name: string;
  category: string;
  images: string[];
  description: string;
}

export const presetThemes: PresetTheme[] = [
  {
    id: "cupcakes",
    name: "Cupcakes",
    category: "food",
    images: [
      "/images/themes/cupcakes/vanilla.png",
      "/images/themes/cupcakes/chocolate.png",
      "/images/themes/cupcakes/strawberry.png",
      // ... 更多图片
    ],
    description: "Delicious cupcake themed 2048 game",
  },
  {
    id: "animals",
    name: "Animals",
    category: "nature",
    images: [
      "/images/themes/animals/cat.png",
      "/images/themes/animals/dog.png",
      "/images/themes/animals/elephant.png",
      // ... 更多图片
    ],
    description: "Cute animal themed 2048 game",
  },
  {
    id: "cars",
    name: "Cars",
    category: "vehicles",
    images: [
      "/images/themes/cars/sedan.png",
      "/images/themes/cars/suv.png",
      "/images/themes/cars/sports.png",
      // ... 更多图片
    ],
    description: "Exciting car themed 2048 game",
  },
];
```

#### 用户上传图片处理

```typescript
// lib/imageProcessing/userUpload.ts
export class ImageProcessor {
  async processUserImages(files: File[]): Promise<string[]> {
    const processedImages: string[] = [];

    for (const file of files) {
      try {
        const processedImage = await this.processImage(file);
        processedImages.push(processedImage);
      } catch (error) {
        console.error("Image processing failed:", error);
      }
    }

    return processedImages;
  }

  private async processImage(file: File): Promise<string> {
    return new Promise((resolve, reject) => {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      const img = new Image();

      img.onload = () => {
        // 设置画布大小为512x512
        canvas.width = 512;
        canvas.height = 512;

        // 计算缩放和居中
        const scale = Math.min(512 / img.width, 512 / img.height);
        const x = (512 - img.width * scale) / 2;
        const y = (512 - img.height * scale) / 2;

        // 绘制白色背景
        ctx!.fillStyle = "#ffffff";
        ctx!.fillRect(0, 0, 512, 512);

        // 绘制图片
        ctx!.drawImage(img, x, y, img.width * scale, img.height * scale);

        // 转换为base64
        const dataUrl = canvas.toDataURL("image/png");
        resolve(dataUrl);
      };

      img.onerror = reject;
      img.src = URL.createObjectURL(file);
    });
  }
}
```

## 🎮 动态游戏生成系统

### 1. 游戏主题管理器

```typescript
// lib/game/themeManager.ts
export interface GameTheme {
  id: string;
  name: string;
  images: string[];
  colors: {
    background: string;
    tile: string;
    text: string;
    accent: string;
  };
  labels: string[];
  description: string;
  createdAt: Date;
  isCustom: boolean;
}

export class ThemeManager {
  private themes: Map<string, GameTheme> = new Map();

  async createCustomTheme(
    name: string,
    images: string[],
    colors?: Partial<GameTheme["colors"]>
  ): Promise<GameTheme> {
    const themeId = this.generateThemeId(name);

    const theme: GameTheme = {
      id: themeId,
      name,
      images,
      colors: {
        background: colors?.background || "#fdf6e3",
        tile: colors?.tile || "#f0e68c",
        text: colors?.text || "#2f4f4f",
        accent: colors?.accent || "#ff69b4",
      },
      labels: this.generateLabels(name, images.length),
      description: `${name} themed 2048 game`,
      createdAt: new Date(),
      isCustom: true,
    };

    this.themes.set(themeId, theme);
    await this.saveTheme(theme);

    return theme;
  }

  private generateThemeId(name: string): string {
    return name.toLowerCase().replace(/[^a-z0-9]/g, "-");
  }

  private generateLabels(name: string, count: number): string[] {
    const labels = [];
    for (let i = 0; i < count; i++) {
      labels.push(`${name} ${i + 1}`);
    }
    return labels;
  }

  private async saveTheme(theme: GameTheme): Promise<void> {
    // 保存到localStorage或数据库
    const themes = JSON.parse(localStorage.getItem("custom-themes") || "{}");
    themes[theme.id] = theme;
    localStorage.setItem("custom-themes", JSON.stringify(themes));
  }

  async loadTheme(themeId: string): Promise<GameTheme | null> {
    // 先检查内存中的主题
    if (this.themes.has(themeId)) {
      return this.themes.get(themeId)!;
    }

    // 从localStorage加载
    const themes = JSON.parse(localStorage.getItem("custom-themes") || "{}");
    const theme = themes[themeId];

    if (theme) {
      this.themes.set(themeId, theme);
      return theme;
    }

    return null;
  }
}
```

### 2. 动态游戏生成器

```typescript
// lib/game/dynamicGameGenerator.ts
export class DynamicGameGenerator {
  private themeManager: ThemeManager;
  private imageGenerator: ImageGenerator;

  constructor() {
    this.themeManager = new ThemeManager();
    this.imageGenerator = new ImageGenerator(process.env.STABILITY_API_KEY!);
  }

  async generateGameFromTheme(themeName: string): Promise<GameTheme> {
    // 1. 生成图片
    const images = await this.imageGenerator.generateThemeImages(themeName, 12);

    // 2. 创建主题
    const theme = await this.themeManager.createCustomTheme(themeName, images);

    // 3. 生成游戏页面
    await this.generateGamePage(theme);

    return theme;
  }

  async generateGameFromImages(
    themeName: string,
    images: string[]
  ): Promise<GameTheme> {
    // 1. 创建主题
    const theme = await this.themeManager.createCustomTheme(themeName, images);

    // 2. 生成游戏页面
    await this.generateGamePage(theme);

    return theme;
  }

  private async generateGamePage(theme: GameTheme): Promise<void> {
    // 生成动态路由页面
    const pageContent = this.generatePageContent(theme);

    // 这里可以动态创建Next.js页面文件
    // 或者使用动态路由
  }

  private generatePageContent(theme: GameTheme): string {
    return `
import { SEOHead } from '@/components/seo/SEOHead';
import { DynamicGameBoard } from '@/components/game/DynamicGameBoard';
import { theme } from '@/lib/game/themes/${theme.id}';

export default function ${theme.name}Page() {
  return (
    <>
      <SEOHead 
        title="${theme.name} 2048 - Play Online Free"
        description="Play ${theme.name} 2048 online for free! Custom themed puzzle game."
        keywords="${theme.name} 2048, ${theme.name} puzzle game, custom 2048"
      />
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
        <div className="container mx-auto px-4 py-8">
          <h1 className="text-4xl font-bold text-center mb-8">${theme.name} 2048</h1>
          <DynamicGameBoard theme={theme} />
        </div>
      </div>
    </>
  );
}
    `;
  }
}
```

### 3. 动态游戏组件

```typescript
// components/game/DynamicGameBoard.tsx
"use client";

import React, { useState, useEffect } from "react";
import { GameTheme } from "@/lib/game/themeManager";
import { Game2048 } from "@/lib/game/gameLogic";

interface DynamicGameBoardProps {
  theme: GameTheme;
}

export const DynamicGameBoard: React.FC<DynamicGameBoardProps> = ({
  theme,
}) => {
  const [game, setGame] = useState<Game2048 | null>(null);
  const [gameState, setGameState] = useState<any>(null);

  useEffect(() => {
    const newGame = new Game2048({
      size: 4,
      targetValue: 4096,
      theme: theme.id,
      difficulty: "medium",
    });

    newGame.loadGame();
    setGame(newGame);
    setGameState(newGame.getState());
  }, [theme]);

  const handleMove = (direction: string) => {
    if (!game) return;

    const moved = game.move(direction as any);
    if (moved) {
      setGameState(game.getState());
    }
  };

  if (!gameState) {
    return <div>Loading...</div>;
  }

  return (
    <div className="max-w-4xl mx-auto">
      <div className="grid md:grid-cols-3 gap-8">
        {/* 游戏统计 */}
        <div className="md:col-span-1">
          <div className="bg-white rounded-lg shadow-lg p-6">
            <h2 className="text-2xl font-bold mb-4">Score</h2>
            <div className="text-3xl font-bold text-blue-600">
              {gameState.score}
            </div>
            <div className="text-sm text-gray-500">
              Best: {gameState.bestScore}
            </div>
          </div>
        </div>

        {/* 游戏棋盘 */}
        <div className="md:col-span-2 flex justify-center">
          <div className="bg-white rounded-lg shadow-lg p-4">
            <div className="grid grid-cols-4 gap-2 w-80 h-80 bg-gray-300 rounded-lg p-2">
              {gameState.board.map((row: any[], rowIndex: number) =>
                row.map((tile: any, colIndex: number) => (
                  <div
                    key={`${rowIndex}-${colIndex}`}
                    className="w-full h-full bg-gray-100 rounded-lg flex items-center justify-center"
                  >
                    {tile && (
                      <div
                        className="w-full h-full rounded-lg flex items-center justify-center"
                        style={{
                          backgroundColor: theme.colors.tile,
                          color: theme.colors.text,
                        }}
                      >
                        <img
                          src={theme.images[tile.value - 1] || theme.images[0]}
                          alt={theme.labels[tile.value - 1] || theme.name}
                          className="w-12 h-12 object-contain"
                        />
                      </div>
                    )}
                  </div>
                ))
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};
```

## 🎨 用户界面设计

### 1. 主题选择页面

```typescript
// app/create/page.tsx
"use client";

import { useState } from "react";
import { SEOHead } from "@/components/seo/SEOHead";
import { ThemeSelector } from "@/components/theme/ThemeSelector";
import { ImageUploader } from "@/components/theme/ImageUploader";
import { DynamicGameGenerator } from "@/lib/game/dynamicGameGenerator";

export default function CreatePage() {
  const [selectedTheme, setSelectedTheme] = useState<string>("");
  const [customImages, setCustomImages] = useState<File[]>([]);
  const [isGenerating, setIsGenerating] = useState(false);

  const handleThemeGeneration = async () => {
    setIsGenerating(true);

    try {
      const generator = new DynamicGameGenerator();
      let theme;

      if (customImages.length > 0) {
        // 使用用户上传的图片
        const imageProcessor = new ImageProcessor();
        const processedImages = await imageProcessor.processUserImages(
          customImages
        );
        theme = await generator.generateGameFromImages(
          selectedTheme,
          processedImages
        );
      } else {
        // 使用AI生成图片
        theme = await generator.generateGameFromTheme(selectedTheme);
      }

      // 跳转到生成的游戏页面
      window.location.href = `/${theme.id}`;
    } catch (error) {
      console.error("Theme generation failed:", error);
    } finally {
      setIsGenerating(false);
    }
  };

  return (
    <>
      <SEOHead
        title="Create Custom 2048 Game - Playing2048.com"
        description="Create your own custom 2048 game with any theme you want!"
        keywords="custom 2048, create 2048 game, personalized 2048"
      />

      <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-100">
        <div className="container mx-auto px-4 py-8">
          <h1 className="text-4xl font-bold text-center mb-8">
            Create Your Custom 2048 Game
          </h1>

          <div className="max-w-4xl mx-auto">
            <div className="bg-white rounded-lg shadow-lg p-8">
              <h2 className="text-2xl font-bold mb-6">Choose Your Theme</h2>

              {/* 预设主题选择 */}
              <ThemeSelector onSelect={setSelectedTheme} />

              {/* 自定义图片上传 */}
              <div className="mt-8">
                <h3 className="text-xl font-bold mb-4">
                  Or Upload Your Own Images
                </h3>
                <ImageUploader onImagesSelected={setCustomImages} />
              </div>

              {/* 生成按钮 */}
              <div className="mt-8 text-center">
                <button
                  onClick={handleThemeGeneration}
                  disabled={
                    (!selectedTheme && customImages.length === 0) ||
                    isGenerating
                  }
                  className="bg-blue-500 text-white px-8 py-3 rounded-lg hover:bg-blue-600 disabled:opacity-50"
                >
                  {isGenerating ? "Generating..." : "Generate My 2048 Game"}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </>
  );
}
```

### 2. 主题选择器组件

```typescript
// components/theme/ThemeSelector.tsx
"use client";

import { useState } from "react";
import { presetThemes } from "@/lib/imageLibrary/presetThemes";

interface ThemeSelectorProps {
  onSelect: (theme: string) => void;
}

export const ThemeSelector: React.FC<ThemeSelectorProps> = ({ onSelect }) => {
  const [searchTerm, setSearchTerm] = useState("");

  const filteredThemes = presetThemes.filter(
    (theme) =>
      theme.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      theme.category.toLowerCase().includes(searchTerm.toLowerCase())
  );

  return (
    <div>
      <input
        type="text"
        placeholder="Search themes..."
        value={searchTerm}
        onChange={(e) => setSearchTerm(e.target.value)}
        className="w-full p-3 border border-gray-300 rounded-lg mb-4"
      />

      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        {filteredThemes.map((theme) => (
          <div
            key={theme.id}
            onClick={() => onSelect(theme.name)}
            className="bg-gray-50 rounded-lg p-4 cursor-pointer hover:bg-gray-100 transition-colors"
          >
            <img
              src={theme.images[0]}
              alt={theme.name}
              className="w-16 h-16 mx-auto mb-2 object-contain"
            />
            <h3 className="text-center font-bold">{theme.name}</h3>
            <p className="text-center text-sm text-gray-500">
              {theme.category}
            </p>
          </div>
        ))}
      </div>
    </div>
  );
};
```

## 🚀 实施步骤

### 第 1 步：设置图片生成 API

1. 注册 Stability AI 或 OpenAI API
2. 配置 API 密钥
3. 测试图片生成功能

### 第 2 步：实现动态路由

1. 创建`[themeId]/page.tsx`动态路由
2. 实现主题加载逻辑
3. 测试动态页面生成

### 第 3 步：用户界面开发

1. 创建主题选择页面
2. 实现图片上传功能
3. 添加游戏生成流程

### 第 4 步：优化和测试

1. 图片生成质量优化
2. 游戏性能优化
3. 用户体验测试

这个方案可以让你实现真正的自定义化 2048 游戏，用户可以选择任何主题，系统会自动生成对应的游戏！
